<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 창작 구역 - 도깨비 메타버스</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #e74c3c 30%, #f39c12 60%, #27ae60 100%);
            color: white;
            overflow: hidden;
        }
        
        #creative-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
        }
        
        /* 메인 UI 컨테이너 */
        .ui-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .ui-container > * {
            pointer-events: auto;
        }
        
        /* 상태 표시 */
        .status-display {
            background: rgba(142, 68, 173, 0.9);
            border: 2px solid #ff6b9d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
        }
        
        /* 컨트롤 패널 */
        .control-panel {
            background: rgba(142, 68, 173, 0.95);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
            min-width: 300px;
        }
        
        .control-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #e91e63 100%);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 12px 16px;
            margin: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
        }
        
        /* 뒤로가기 버튼 */
        .back-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            border: none;
            border-radius: 10px;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        /* 창작 도깨비 카드 */
        .creative-goblin-card {
            background: rgba(142, 68, 173, 0.9);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .creative-goblin-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            border-color: #ff9fbf;
        }
        
        .goblin-name {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b9d;
            margin-bottom: 8px;
        }
        
        .goblin-specialty {
            font-size: 14px;
            color: #ffb3d9;
            margin-bottom: 5px;
        }
        
        /* AI 채팅 시스템 */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            background: rgba(155, 89, 182, 0.95);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 1002;
            display: none;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #ff6b9d 0%, #e84393 100%);
            color: white;
            padding: 15px;
            border-radius: 13px 13px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 200px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .user-message {
            background: #e84393;
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background: rgba(255, 107, 157, 0.3);
            color: #ff6b9d;
            border: 1px solid #ff6b9d;
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #ff6b9d;
        }
        
        .chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ff6b9d;
            border-radius: 8px;
            background: rgba(255, 107, 157, 0.1);
            color: white;
            font-size: 14px;
        }
        
        .chat-input::placeholder {
            color: #ffb3d9;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #e84393;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.3);
        }
    </style>
</head>
<body>
    <!-- 뒤로가기 버튼 -->
    <button class="back-btn" onclick="goBackToVillage()">← 🏘️ 도깨비 마을로</button>
    
    <!-- 메인 캔버스 -->
    <canvas id="creative-canvas"></canvas>
    
    <!-- UI 컨테이너 -->
    <div class="ui-container">
        <!-- 상태 표시 -->
        <div class="status-display" id="statusDisplay">
            🎨 창작 구역에 오신 것을 환영합니다!
        </div>
        
        <!-- 컨트롤 패널 -->
        <div class="control-panel">
            <h2 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">🎨 창작 구역</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #ff6b9d; margin-bottom: 10px; font-size: 16px;">🎮 컨트롤</h3>
                <button class="control-btn" onclick="toggleAvatar()">🎭 아티스트 아바타</button>
                <button class="control-btn" onclick="resetCamera()">📷 카메라 리셋</button>
                <button class="control-btn" onclick="togglePalette()">🌈 색상 팔레트</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #ff6b9d; margin-bottom: 10px; font-size: 16px;">🎨 창작 도깨비들</h3>
                <div id="creativeGoblinGrid">
                    <!-- 창작 도깨비들이 여기에 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI 채팅 시스템 -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <span id="chatTitle">🎨 마스터 화가와 대화</span>
            <button class="chat-close" onclick="closeChat()">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- 채팅 메시지들이 여기에 표시됩니다 -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="창작 도깨비에게 예술적 영감을 구해보세요..." onkeypress="handleChatKeyPress(event)">
        </div>
    </div>
    
    <!-- Three.js 및 GSAP 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <script>
        // 🎨 창작 구역 전역 변수
        let scene, camera, renderer, controls;
        let avatar = null;
        let isSystemReady = false;
        
        // 🎨 창작 전문 도깨비들
        const creativeGoblins = [
            { name: '🎨 마스터 화가', specialty: '회화', description: '모든 감정을 캔버스에 담아내는 예술 도깨비', emoji: '🎨', color: 0xff6b9d },
            { name: '🎵 음악마에스트로', specialty: '작곡', description: '마음을 울리는 선율을 만들어내는 도깨비', emoji: '🎵', color: 0x9b59b6 },
            { name: '✍️ 스토리텔러', specialty: '문학', description: '감동적인 이야기를 엮어내는 문학 도깨비', emoji: '✍️', color: 0x3498db },
            { name: '🎬 영화감독', specialty: '영상', description: '꿈같은 영상을 창조하는 비주얼 도깨비', emoji: '🎬', color: 0xe74c3c },
            { name: '🏺 조각가', specialty: '조각', description: '돌과 흙에 생명을 불어넣는 조형 도깨비', emoji: '🏺', color: 0xf39c12 },
            { name: '💃 무용가', specialty: '댄스', description: '몸짓으로 예술을 표현하는 무용 도깨비', emoji: '💃', color: 0x27ae60 }
        ];
        
        // 🎯 상태 업데이트 함수
        function updateStatus(message) {
            const statusElement = document.getElementById('statusDisplay');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        // 🔙 도깨비 마을로 돌아가기
        function goBackToVillage() {
            updateStatus('🏘️ 도깨비 마을로 돌아가는 중...');
            // GitHub Pages용 베이스 URL 계산
            const baseURL = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
            setTimeout(() => {
                window.location.href = baseURL + 'index.html';
            }, 1000);
        }
        
        // 🎮 아바타 토글
        function toggleAvatar() {
            if (!avatar) {
                createAvatar();
            } else {
                removeAvatar();
            }
        }
        
        // 🎭 아티스트 아바타 생성
        function createAvatar() {
            avatar = new THREE.Group();
            
            // 아티스트 몸체 (원통형, 화려한 옷)
            const bodyGeometry = new THREE.CylinderGeometry(0.4, 0.5, 1.8);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff6b9d,
                shininess: 50
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1;
            avatar.add(body);
            
            // 아티스트 머리
            const headGeometry = new THREE.SphereGeometry(0.5);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xf4d1ae });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 2.5;
            avatar.add(head);
            
            // 베레모 (예술가 모자)
            const beretGeometry = new THREE.CylinderGeometry(0.6, 0.6, 0.2);
            const beretMaterial = new THREE.MeshPhongMaterial({ color: 0x2c3e50 });
            const beret = new THREE.Mesh(beretGeometry, beretMaterial);
            beret.position.y = 3.2;
            beret.rotation.z = 0.3;
            avatar.add(beret);
            
            // 팔레트 (왼손)
            const paletteGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1);
            const paletteMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const palette = new THREE.Mesh(paletteGeometry, paletteMaterial);
            palette.position.set(-0.8, 1.5, 0);
            palette.rotation.z = Math.PI / 2;
            avatar.add(palette);
            
            // 붓 (오른손)
            const brushGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8);
            const brushMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 });
            const brush = new THREE.Mesh(brushGeometry, brushMaterial);
            brush.position.set(0.8, 1.8, 0);
            brush.rotation.z = -0.5;
            avatar.add(brush);
            
            // 창작 오라 (무지개 색상)
            for (let i = 0; i < 5; i++) {
                const auraGeometry = new THREE.RingGeometry(0.8 + i * 0.2, 1.2 + i * 0.2, 16);
                const rainbowColors = [0xff0000, 0xff8800, 0xffff00, 0x00ff00, 0x0088ff, 0x8800ff];
                const auraMaterial = new THREE.MeshBasicMaterial({ 
                    color: rainbowColors[i % rainbowColors.length],
                    transparent: true,
                    opacity: 0.3,
                    side: THREE.DoubleSide
                });
                const aura = new THREE.Mesh(auraGeometry, auraMaterial);
                aura.rotation.x = -Math.PI / 2;
                aura.position.y = 0.1;
                avatar.add(aura);
                
                gsap.to(aura.rotation, {
                    z: Math.PI * 2,
                    duration: 4 - i * 0.5,
                    repeat: -1,
                    ease: "none"
                });
            }
            
            avatar.position.set(0, 0, 0);
            scene.add(avatar);
            
            if (camera && controls) {
                gsap.to(camera.position, {
                    x: 5, y: 8, z: 12,
                    duration: 1.5,
                    ease: "power2.out"
                });
                gsap.to(controls.target, {
                    x: 0, y: 1, z: 0,
                    duration: 1.5,
                    ease: "power2.out",
                    onUpdate: () => controls.update()
                });
            }
            
            updateStatus('🎭 아티스트 아바타가 창작 모드로 활성화되었습니다!');
        }
        
        // 🎭 아바타 제거
        function removeAvatar() {
            if (avatar) {
                while(avatar.children.length > 0) {
                    const child = avatar.children[0];
                    avatar.remove(child);
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) child.material.dispose();
                }
                scene.remove(avatar);
                avatar = null;
                updateStatus('👋 아티스트 아바타가 작업을 마쳤습니다');
            }
        }
        
        // 📷 카메라 리셋
        function resetCamera() {
            if (camera && controls) {
                gsap.to(camera.position, {
                    x: 0, y: 18, z: 28,
                    duration: 1.5,
                    ease: "power2.out"
                });
                gsap.to(controls.target, {
                    x: 0, y: 0, z: 0,
                    duration: 1.5,
                    ease: "power2.out",
                    onUpdate: () => controls.update()
                });
                updateStatus('📷 카메라가 창작 구역 중심으로 리셋되었습니다');
            }
        }
        
        // 🌈 색상 팔레트 토글
        function togglePalette() {
            const palettes = ['🌈 무지개', '🔥 불꽃', '🌊 바다', '🌸 봄꽃', '🍂 가을'];
            const randomPalette = palettes[Math.floor(Math.random() * palettes.length)];
            updateStatus(`🎨 창작 구역이 ${randomPalette} 팔레트로 변환되었습니다`);
        }
        
        // 🏷️ 창작 도깨비 이름표 생성
        function createCreativeGoblinNameTag(name, specialty) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 256;
            
            // 예술적 그라디언트 배경
            const gradient = context.createRadialGradient(256, 128, 0, 256, 128, 300);
            gradient.addColorStop(0, 'rgba(142, 68, 173, 0.9)');
            gradient.addColorStop(0.7, 'rgba(231, 76, 60, 0.7)');
            gradient.addColorStop(1, 'rgba(243, 156, 18, 0.9)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // 아트 브러시 테두리
            context.strokeStyle = '#ff6b9d';
            context.lineWidth = 8;
            context.setLineDash([20, 10]);
            context.strokeRect(4, 4, canvas.width - 8, canvas.height - 8);
            
            // 이름 텍스트 (예술적 폰트)
            context.shadowColor = '#ff6b9d';
            context.shadowBlur = 15;
            context.fillStyle = '#ff6b9d';
            context.font = 'bold 44px Arial';
            context.textAlign = 'center';
            context.fillText(name, canvas.width / 2, 80);
            
            // 전문 분야 텍스트
            context.shadowBlur = 8;
            context.fillStyle = '#ffb3d9';
            context.font = '30px Arial';
            context.fillText(specialty, canvas.width / 2, 130);
            
            // 예술적 붓터치들
            context.setLineDash([]);
            context.strokeStyle = '#ff9fbf';
            context.lineWidth = 3;
            for (let i = 0; i < 5; i++) {
                context.beginPath();
                context.moveTo(40 + i * 80, 160);
                context.bezierCurveTo(
                    60 + i * 80, 140,
                    80 + i * 80, 180,
                    100 + i * 80, 160
                );
                context.stroke();
            }
            
            // 컬러 도트들
            const colors = ['#ff6b9d', '#9b59b6', '#3498db', '#e74c3c', '#f39c12', '#27ae60'];
            for (let i = 0; i < 6; i++) {
                context.fillStyle = colors[i];
                context.beginPath();
                context.arc(70 + i * 70, 200, 12, 0, Math.PI * 2);
                context.fill();
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            
            const planeGeometry = new THREE.PlaneGeometry(4, 2);
            const planeMaterial = new THREE.MeshBasicMaterial({ 
                map: texture, 
                transparent: true,
                side: THREE.DoubleSide
            });
            
            const nameTagMesh = new THREE.Mesh(planeGeometry, planeMaterial);
            nameTagMesh.userData.isNameTag = true;
            
            return nameTagMesh;
        }
        
        // 🎨 3D 창작 도깨비들 생성
        function createCreative3DGoblins() {
            creativeGoblins.forEach((goblin, index) => {
                const goblin3D = createCreative3DGoblin(goblin, index);
                scene.add(goblin3D);
            });
        }
        
        // 🎨 개별 3D 창작 도깨비 생성
        function createCreative3DGoblin(goblinData, index) {
            const goblinGroup = new THREE.Group();
            
            // 예술적 몸체 (다이아몬드 형태)
            const bodyGeometry = new THREE.OctahedronGeometry(1.2);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: goblinData.color,
                shininess: 80,
                transparent: true,
                opacity: 0.85
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1.5;
            goblinGroup.add(body);
            
            // 아티스트 머리
            const headGeometry = new THREE.SphereGeometry(0.8);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xf4d1ae });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 3;
            goblinGroup.add(head);
            
            // 창작 도구들 (분야별로 다름)
            const toolGeometry = new THREE.BoxGeometry(0.2, 1, 0.2);
            const toolMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 });
            const tool = new THREE.Mesh(toolGeometry, toolMaterial);
            tool.position.set(1, 2, 0);
            tool.rotation.z = -0.5;
            goblinGroup.add(tool);
            
            // 베레모
            const beretGeometry = new THREE.CylinderGeometry(0.7, 0.7, 0.2);
            const beretMaterial = new THREE.MeshPhongMaterial({ color: 0x2c3e50 });
            const beret = new THREE.Mesh(beretGeometry, beretMaterial);
            beret.position.y = 3.7;
            beret.rotation.z = 0.3;
            goblinGroup.add(beret);
            
            // 창작 영감 파티클들
            for (let i = 0; i < 8; i++) {
                const particleGeometry = new THREE.SphereGeometry(0.1);
                const particleColors = [0xff6b9d, 0x9b59b6, 0x3498db, 0xe74c3c, 0xf39c12, 0x27ae60];
                const particleMaterial = new THREE.MeshBasicMaterial({ 
                    color: particleColors[i % particleColors.length],
                    transparent: true,
                    opacity: 0.7
                });
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                
                const angle = (i / 8) * Math.PI * 2;
                const radius = 1.5 + Math.sin(i) * 0.5;
                particle.position.set(
                    Math.cos(angle) * radius,
                    3 + Math.sin(i) * 0.3,
                    Math.sin(angle) * radius
                );
                goblinGroup.add(particle);
                
                // 파티클 애니메이션
                gsap.to(particle.position, {
                    y: particle.position.y + 1,
                    duration: 2 + i * 0.2,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut"
                });
                
                gsap.to(particle.rotation, {
                    z: Math.PI * 2,
                    duration: 3 + i * 0.3,
                    repeat: -1,
                    ease: "none"
                });
            }
            
            // 이름표 추가
            const nameTag = createCreativeGoblinNameTag(goblinData.name, goblinData.specialty);
            nameTag.position.set(0, 5.5, 0);
            goblinGroup.add(nameTag);
            
            // 위치 설정 (원형 배치)
            const angle = (index / creativeGoblins.length) * Math.PI * 2;
            const radius = 20;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            goblinGroup.position.set(x, 0, z);
            
            goblinGroup.lookAt(0, 1, 0);
            
            goblinGroup.userData = {
                goblinData: goblinData,
                index: index,
                isCreativeGoblin: true
            };
            
            // 예술적 애니메이션
            gsap.to(goblinGroup.position, {
                y: Math.sin(index * 1.5) * 0.6,
                duration: 4 + index * 0.3,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });
            
            // 몸체 회전
            gsap.to(body.rotation, {
                y: Math.PI * 2,
                duration: 10 + index,
                repeat: -1,
                ease: "none"
            });
            
            return goblinGroup;
        }
        
        // 🎨 창작 도깨비 클릭 처리
        function onCreativeCanvasClick(event) {
            if (!camera || !scene) return;
            
            const rect = renderer.domElement.getBoundingClientRect();
            const mouse = new THREE.Vector2();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            if (intersects.length > 0) {
                let clickedObject = intersects[0].object;
                
                while (clickedObject && !clickedObject.userData.isCreativeGoblin) {
                    clickedObject = clickedObject.parent;
                }
                
                if (clickedObject && clickedObject.userData.isCreativeGoblin) {
                    const goblinData = clickedObject.userData.goblinData;
                    selectCreativeGoblin(goblinData);
                    
                    gsap.to(clickedObject.scale, {
                        x: 1.3, y: 1.3, z: 1.3,
                        duration: 0.2,
                        yoyo: true,
                        repeat: 1,
                        ease: "power2.out"
                    });
                }
            }
        }
        
        // 🎨 창작 도깨비 카드 생성
        function createCreativeGoblinCards() {
            const gridElement = document.getElementById('creativeGoblinGrid');
            
            creativeGoblins.forEach((goblin, index) => {
                const card = document.createElement('div');
                card.className = 'creative-goblin-card';
                card.onclick = () => selectCreativeGoblin(goblin);
                
                card.innerHTML = `
                    <div class="goblin-name">${goblin.name}</div>
                    <div class="goblin-specialty">${goblin.specialty}</div>
                    <div style="font-size: 12px; color: #ffd9ec;">${goblin.description}</div>
                `;
                
                gridElement.appendChild(card);
            });
        }
        
        // 🎨 창작 도깨비 선택
        function selectCreativeGoblin(goblin) {
            updateStatus(`🎨 ${goblin.name}과 창작 협업을 시작합니다!`);
            console.log('선택된 창작 도깨비:', goblin);
            
            // 채팅 창 열기
            openChat(goblin);
        }
        
        // 💬 채팅 시스템 관련 변수
        let currentChatGoblin = null;
        let chatHistory = [];
        
        // 💬 채팅 창 열기
        function openChat(goblin) {
            currentChatGoblin = goblin;
            const chatContainer = document.getElementById('chatContainer');
            const chatTitle = document.getElementById('chatTitle');
            const chatMessages = document.getElementById('chatMessages');
            
            chatTitle.textContent = `${goblin.emoji} ${goblin.name}와 대화`;
            chatContainer.style.display = 'flex';
            
            // 환영 메시지 추가
            addChatMessage('ai', `안녕하세요! 저는 ${goblin.name}입니다. ${goblin.description} 어떤 창작 도움이 필요하신가요?`);
            
            // 입력창에 포커스
            document.getElementById('chatInput').focus();
        }
        
        // 💬 채팅 창 닫기
        function closeChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.style.display = 'none';
            currentChatGoblin = null;
            
            // 채팅 기록 초기화
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            chatHistory = [];
        }
        
        // 💬 채팅 메시지 추가
        function addChatMessage(type, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            messageDiv.textContent = message;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 채팅 기록에 추가
            chatHistory.push({ type, message, timestamp: new Date() });
        }
        
        // 💬 채팅 입력 처리
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message && currentChatGoblin) {
                    // 사용자 메시지 추가
                    addChatMessage('user', message);
                    input.value = '';
                    
                    // AI 응답 생성 (시뮬레이션)
                    setTimeout(() => {
                        const aiResponse = generateCreativeGoblinResponse(message, currentChatGoblin);
                        addChatMessage('ai', aiResponse);
                    }, 1000);
                }
            }
        }
        
        // 🤖 창작 도깨비 AI 응답 생성
        function generateCreativeGoblinResponse(userMessage, goblin) {
            const lowerMessage = userMessage.toLowerCase();
            
            // 도깨비별 특화 응답
            switch (goblin.name) {
                case '🎨 마스터 화가':
                    if (lowerMessage.includes('색깔') || lowerMessage.includes('색상') || lowerMessage.includes('그림')) {
                        return "색은 감정의 언어예요. 빨강은 열정, 파랑은 평온, 노랑은 기쁨을 표현해요. 어떤 감정을 그리고 싶으신가요?";
                    } else if (lowerMessage.includes('영감') || lowerMessage.includes('아이디어')) {
                        return "영감은 일상 속 작은 순간들에서 찾을 수 있어요. 창문 너머 풍경, 사람들의 표정, 빛의 변화를 관찰해보세요.";
                    } else if (lowerMessage.includes('기법') || lowerMessage.includes('그리는')) {
                        return "완벽함보다는 감정을 담는 것이 중요해요. 붓 터치 하나하나에 마음을 담아보세요.";
                    } else {
                        return "예술은 마음의 창입니다. 당신만의 독특한 시각으로 세상을 바라보고 표현해보세요.";
                    }
                    
                case '🎵 음악마에스트로':
                    if (lowerMessage.includes('음악') || lowerMessage.includes('작곡') || lowerMessage.includes('멜로디')) {
                        return "음악은 시간을 조각하는 예술이에요. 감정의 높낮이를 멜로디로 표현해보세요.";
                    } else if (lowerMessage.includes('리듬') || lowerMessage.includes('박자')) {
                        return "리듬은 음악의 심장박동이에요. 자연의 소리, 걸음걸이, 호흡에서 리듬을 찾아보세요.";
                    } else if (lowerMessage.includes('악기') || lowerMessage.includes('연주')) {
                        return "악기는 영혼의 목소리를 대신해줘요. 기술보다는 마음을 전달하는 것이 중요해요.";
                    } else {
                        return "음악은 국경과 언어를 넘나드는 마법이에요. 당신의 마음을 소리로 표현해보세요.";
                    }
                    
                case '✍️ 스토리텔러':
                    if (lowerMessage.includes('이야기') || lowerMessage.includes('소설') || lowerMessage.includes('글쓰기')) {
                        return "좋은 이야기는 독자의 마음에 오래 남아요. 등장인물의 감정에 공감할 수 있게 써보세요.";
                    } else if (lowerMessage.includes('캐릭터') || lowerMessage.includes('인물')) {
                        return "매력적인 캐릭터는 결점도 가져야 해요. 완벽한 인물보다는 인간적인 면이 있는 인물이 사랑받아요.";
                    } else if (lowerMessage.includes('플롯') || lowerMessage.includes('구성')) {
                        return "시작은 호기심을, 중간은 긴장감을, 끝은 여운을 남겨야 해요. 독자가 다음 페이지를 넘기고 싶게 만드세요.";
                    } else {
                        return "모든 사람에게는 하나씩의 특별한 이야기가 있어요. 당신의 경험도 소중한 이야기가 될 수 있어요.";
                    }
                    
                case '🎬 영화감독':
                    if (lowerMessage.includes('영화') || lowerMessage.includes('영상') || lowerMessage.includes('촬영')) {
                        return "영화는 시각과 청각으로 감정을 전달하는 종합예술이에요. 한 프레임 한 프레임이 의미를 가져야 해요.";
                    } else if (lowerMessage.includes('스토리보드') || lowerMessage.includes('연출')) {
                        return "좋은 연출은 관객이 캐릭터의 감정에 몰입하게 해요. 카메라 각도와 조명으로 분위기를 만들어보세요.";
                    } else if (lowerMessage.includes('편집') || lowerMessage.includes('몽타주')) {
                        return "편집은 영화의 리듬을 만들어요. 빠른 컷은 긴장감을, 긴 컷은 여유로움을 표현해요.";
                    } else {
                        return "영화는 꿈을 현실로 만드는 마법이에요. 당신의 상상력을 화면에 담아보세요.";
                    }
                    
                case '🏺 조각가':
                    if (lowerMessage.includes('조각') || lowerMessage.includes('조형') || lowerMessage.includes('돌')) {
                        return "조각은 불필요한 부분을 제거해서 본질을 드러내는 예술이에요. 재료 속에 숨어있는 형태를 발견해보세요.";
                    } else if (lowerMessage.includes('형태') || lowerMessage.includes('모양')) {
                        return "형태는 공간을 점유하는 방식이에요. 빛과 그림자의 상호작용을 고려해서 작업해보세요.";
                    } else if (lowerMessage.includes('질감') || lowerMessage.includes('표면')) {
                        return "질감은 손끝으로 느끼는 감정이에요. 거칠거나 부드러운 표면이 다른 느낌을 전달해요.";
                    } else {
                        return "조각은 시간과 공간을 초월하는 예술이에요. 당신의 손끝에서 영원한 형태가 탄생해요.";
                    }
                    
                case '💃 무용가':
                    if (lowerMessage.includes('춤') || lowerMessage.includes('무용') || lowerMessage.includes('동작')) {
                        return "춤은 몸으로 쓰는 시예요. 모든 동작에 감정과 의미를 담아보세요.";
                    } else if (lowerMessage.includes('표현') || lowerMessage.includes('몸짓')) {
                        return "몸은 가장 정직한 표현 도구예요. 마음의 움직임이 자연스럽게 몸짓으로 나타나게 하세요.";
                    } else if (lowerMessage.includes('리듬') || lowerMessage.includes('박자')) {
                        return "리듬은 몸의 언어예요. 음악을 온몸으로 느끼고, 그 감정을 움직임으로 표현해보세요.";
                    } else {
                        return "춤은 순간순간을 예술로 만드는 마법이에요. 당신의 몸짓이 아름다운 이야기가 되도록 하세요.";
                    }
                    
                default:
                    return "창작은 마음에서 시작되는 여행이에요. 당신만의 독특한 시각으로 세상을 표현해보세요.";
            }
        }
        
        // 🎨 창작 구역 환경 생성
        function createCreativeEnvironment() {
            // 🖼️ 아트 갤러리들
            for (let i = 0; i < 12; i++) {
                createArtGallery();
            }
            
            // 🎭 무대들
            for (let i = 0; i < 8; i++) {
                createArtStage();
            }
            
            // 🌈 컬러 분수들
            for (let i = 0; i < 6; i++) {
                createColorFountain();
            }
            
            // 🎪 창작 조명
            createCreativeLighting();
        }
        
        // 🖼️ 아트 갤러리 생성
        function createArtGallery() {
            const galleryGroup = new THREE.Group();
            
            // 갤러리 벽
            const wallGeometry = new THREE.BoxGeometry(6, 8, 0.2);
            const wallMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            galleryGroup.add(wall);
            
            // 액자들
            for (let i = 0; i < 3; i++) {
                const frameGeometry = new THREE.PlaneGeometry(1.5, 2);
                const colors = [0xff6b9d, 0x9b59b6, 0x3498db, 0xe74c3c, 0xf39c12, 0x27ae60];
                const frameMaterial = new THREE.MeshBasicMaterial({ 
                    color: colors[Math.floor(Math.random() * colors.length)],
                    transparent: true,
                    opacity: 0.8
                });
                const frame = new THREE.Mesh(frameGeometry, frameMaterial);
                frame.position.set((i - 1) * 2, 1, 0.2);
                galleryGroup.add(frame);
            }
            
            const x = (Math.random() - 0.5) * 70;
            const z = (Math.random() - 0.5) * 70;
            galleryGroup.position.set(x, 4, z);
            galleryGroup.rotation.y = Math.random() * Math.PI * 2;
            
            scene.add(galleryGroup);
        }
        
        // 🎭 무대 생성
        function createArtStage() {
            const stageGroup = new THREE.Group();
            
            // 무대 바닥
            const stageGeometry = new THREE.CylinderGeometry(4, 4, 0.5);
            const stageMaterial = new THREE.MeshPhongMaterial({ color: 0x8e44ad });
            const stage = new THREE.Mesh(stageGeometry, stageMaterial);
            stageGroup.add(stage);
            
            // 커튼들
            for (let i = 0; i < 8; i++) {
                const curtainGeometry = new THREE.PlaneGeometry(1, 6);
                const curtainMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xe74c3c,
                    transparent: true,
                    opacity: 0.7
                });
                const curtain = new THREE.Mesh(curtainGeometry, curtainMaterial);
                
                const angle = (i / 8) * Math.PI * 2;
                curtain.position.set(Math.cos(angle) * 4.5, 3, Math.sin(angle) * 4.5);
                curtain.lookAt(0, 3, 0);
                stageGroup.add(curtain);
            }
            
            const x = (Math.random() - 0.5) * 80;
            const z = (Math.random() - 0.5) * 80;
            stageGroup.position.set(x, 0, z);
            
            scene.add(stageGroup);
        }
        
        // 🌈 컬러 분수 생성
        function createColorFountain() {
            const fountainGroup = new THREE.Group();
            
            // 분수 베이스
            const baseGeometry = new THREE.CylinderGeometry(2, 2.5, 1);
            const baseMaterial = new THREE.MeshPhongMaterial({ color: 0xecf0f1 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            fountainGroup.add(base);
            
            // 컬러 물방울들
            for (let i = 0; i < 20; i++) {
                const dropGeometry = new THREE.SphereGeometry(0.1);
                const colors = [0xff6b9d, 0x9b59b6, 0x3498db, 0xe74c3c, 0xf39c12, 0x27ae60];
                const dropMaterial = new THREE.MeshBasicMaterial({ 
                    color: colors[Math.floor(Math.random() * colors.length)],
                    transparent: true,
                    opacity: 0.8
                });
                const drop = new THREE.Mesh(dropGeometry, dropMaterial);
                
                drop.position.set(
                    (Math.random() - 0.5) * 3,
                    Math.random() * 8,
                    (Math.random() - 0.5) * 3
                );
                fountainGroup.add(drop);
                
                // 물방울 애니메이션
                gsap.to(drop.position, {
                    y: drop.position.y + 3,
                    duration: 2 + Math.random() * 2,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut"
                });
            }
            
            const x = (Math.random() - 0.5) * 60;
            const z = (Math.random() - 0.5) * 60;
            fountainGroup.position.set(x, 0, z);
            
            scene.add(fountainGroup);
        }
        
        // 🎪 창작 조명
        function createCreativeLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 컬러 스포트라이트들
            const colors = [0xff6b9d, 0x9b59b6, 0x3498db, 0xe74c3c, 0xf39c12, 0x27ae60];
            for (let i = 0; i < 6; i++) {
                const spotLight = new THREE.SpotLight(colors[i], 0.8, 30, Math.PI / 6);
                spotLight.position.set(
                    Math.cos(i) * 25,
                    15,
                    Math.sin(i) * 25
                );
                spotLight.target.position.set(0, 0, 0);
                scene.add(spotLight);
                scene.add(spotLight.target);
                
                // 조명 변화 효과
                gsap.to(spotLight, {
                    intensity: 0.3,
                    duration: 2 + i * 0.3,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut"
                });
            }
        }
        
        // 🎨 창작 구역 초기화
        function initCreativeDistrict() {
            console.log('🎨 창작 구역 초기화 시작...');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2c1810);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 18, 28);
            
            const canvas = document.getElementById('creative-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // 🎨 창작 구역 환경 생성
            createCreativeEnvironment();
            
            // 🎨 3D 창작 도깨비들 생성
            createCreative3DGoblins();
            
            // 🎨 창작 도깨비 카드 생성
            createCreativeGoblinCards();
            
            // 🖱️ 캔버스 클릭 이벤트 추가
            canvas.addEventListener('click', onCreativeCanvasClick);
            
            isSystemReady = true;
            updateStatus('🎨 창작 구역이 완성되었습니다! 예술의 영감을 느껴보세요!');
            
            animate();
        }
        
        // 🎬 애니메이션 루프
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();
            }
            
            if (avatar && controls) {
                controls.target.copy(avatar.position);
                controls.target.y += 1;
            }
            
            // 🏷️ 모든 이름표들이 카메라를 바라보도록 업데이트
            scene.traverse((object) => {
                if (object.userData && object.userData.isNameTag && camera) {
                    object.lookAt(camera.position);
                }
            });
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // 📱 윈도우 리사이즈 처리
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // 🚀 창작 구역 시작
        window.addEventListener('load', () => {
            initCreativeDistrict();
        });
    </script>
</body>
</html>
